' Gambas class file

Public js As CJSON = New CJSON As "JParse"
Private m_json_icons As New Collection
Private m_bEdit As Boolean = False ' flag to edit the file text box
Private m_frm_prop As New FrmProperty[] 
Private m_selected_key As String
Property Read SelectedKey As String


Public Sub cmdDecode_Click()
Dim iResult As Integer
' Dim js As New CJSON
  Dialog.Title = "Choose a file"
  Dialog.Filter = ["*.json", "JSON Files", "*", "All files"]
  Dialog.Path = "."
  If Dialog.OpenFile() Then
    Return ' User pressed Cancel -
  Endif
  txtWorkingFile.Text = Dialog.path 
  js.Clear
  cvJSON.Clear
  'tvJson.Clear()
  js.LineNoWidth = 6
  js.URL = txtWorkingFile.Text
  txtWorkingFile.Foreground = Color.black
  iResult = js.open()
End

Public Sub cmdOpen_Click()



End

' Public Sub cmbGetName_Click()
' 
'   Print js.GetNameFromPath(txtPath.Text)
' 
' End


Private Sub DisplayIcons()

  Dim iconKey As String
  Dim iconName As String
  Dim v As Variant
  ' IconViewIcons.Clear()

 
  For Each v In m_json_icons
    

    iconKey = m_json_icons.Key
   ' IconViewIcons.Add(iconKey, iconKey, v)

  Next

End
Private Sub ShowIcons()
  
  
  Dim iconKey As String
  Dim iconName As String

  IconViewIcons.Clear()

  For Each iconKey In Stock.Icons

    iconName = "icon:/medium/" & iconKey
    IconViewIcons.Add(iconKey, iconKey, Picture[iconName])

  Next
  
End

Public Sub Form_Open()
Dim lPath As String
Dim lFlags As New Byte[2]

' "Boolean", "Number", "String", "Array", "Object"
lPath = Application.Path & "/icons/"
   With m_json_icons
    .Add(Picture.Load(lpath & "json-array.png"), "Array")
   .Add(Picture.Load(lpath & "json-boolean.png"), "Boolean")
   .Add(Picture.Load(lpath & "json-member.png"), "Member")
   .Add(Picture.Load(lpath & "json-null.png"), "Null")
   .Add(Picture.Load(lpath & "json-number.png"), "Number")
   .Add(Picture.Load(lpath & "json-object.png"), "Object")
   .Add(Picture.Load(lpath & "json-string.png"), "String")
   .Add(Picture.Load(lpath & "json-name.png"), "Name")
   .Add(Picture.Load(lpath & "json-value.png"), "Value")
   End With
   lFlags[0] = 0 ' &H30 ' To turn it all on use &H30
   lFlags[1] = &H30 '&H30 ' To turn it all on use &H30
   zns.debugger = New CDebug(lFlags)
   cvJSON.AddColumn("Text", -1)
   cvJSON.AddColumn("Type", -1)
   cvJSON.Columns[0].title = "Tree"
   cvJSON.Columns[1].Title = "Text"
   cvJSON.Columns[2].Title = "Type"
   cvJSON.Resizable = True
   ShowIcons
End





Public Sub JParse_Added(key As String, name As String, value As String, type As String)
  
  zns.debugger.Message(modJSONParse.getParent(key) & Chr$(9) & key & Chr$(9) & "\"" & name & "\" : " & value & Chr$(9) & type, LogLevel.Info)
  ' If tvJson.Exist(modJSONParse.getParent(key)) Then 
  '   tvJson.Add(key, name, m_json_icons[type], modJSONParse.getParent(key))
  ' Else
  '   tvJson.Add(key, name, m_json_icons[type])
  ' Endif
   If cvJson.Exist(modJSONParse.getParent(key)) Then 
    cvJson.Add(key, name, m_json_icons[type], modJSONParse.getParent(key))
    ' cvJSON.MoveTo(key)
    cvJSON[key][1] = IIf(name = "", "", "\"" & name & "\" : ") & value
    cvJSON[key][2] = type
  Else
    cvJson.Add(key, name, m_json_icons[type])
    cvJSON[key][1] = IIf(name = "", "", "\"" & name & "\" : ") & value
    cvJSON[key][2] = type
  Endif
End


Public Sub JParse_DebugMessage(msg As String, Level As Integer)
  
  zns.debugger.Message(msg, Level)
  
End

Public Sub JParse_OpenedURL(pURL As String)
  
    txtWorkingFile.Text = pURL
  
End




' Old Tree View Code marked to be removed by 03-18-19
' Public Sub tvJson_Click()
' 
'   Print "Parent" & modJSONParse.getParent(tvJson.Item.Key) & "Key " & tvJson.Item.Key & " ==> \"" & tvJson.Item.Text & "\" : " & js.GetNameFromPath(tvJson.Item.Key)
'   
'   
' 
' End

Public Sub cmdUnitTest_Click()
  
  modUnitTest.UnitTests(js, cvJson)
  ' modUnitTest.PrintDirectory("./json-test")

  
End

Public Sub Form_Resize()

    
  cvJSON.h = Me.h - 78
  cvJSON.W = Me.w - 208
  tpMain.h = Me.h - 78
  txtWorkingFile.w = Me.w - 64
  txtWorkingFile.Foreground = Color.Black
End

Public Sub txtWorkingFile_DblClick()
  
  m_bEdit = True
  txtWorkingFile.Background = Color.White
End

Public Sub txtWorkingFile_LostFocus()
  
  m_bEdit = False
  txtWorkingFile.Background = Color.Background
  
End

Public Sub txtWorkingFile_KeyPress()
 Dim iResult As Integer
 
 If m_bEdit = False Then 
  cmdDecode.SetFocus
  Stop Event
Endif

 If Asc(Key.text) = 13 Then 
   m_bEdit = False
   cmdDecode.SetFocus
   txtWorkingFile.Background = Color.Background
   If Exist(txtWorkingFile.Text) Then
    js.Clear
    cvJSON.Clear
    'tvJson.Clear()
    js.LineNoWidth = 6
    js.URL = txtWorkingFile.Text
    txtWorkingFile.Foreground = Color.black
    iResult = js.open()
  Endif
 Endif
End

Public Sub cvJSON_Click()
  Dim l_key As String 'Buffer for selected key
  Dim bEditable As Boolean = True
  l_key = cvJson.Item.Key
  If Right(l_key, 1) = "~" Then bEditable = False
  If l_key = "/" Then bEditable = False
  If l_key = "" Then bEditable = False
  If bEditable Then m_selected_key = l_key
  cmdEdit.Enabled = bEditable

End
Public Sub cmdEdit_Click()
  Dim l_key As String ' buffer for the key selected
' Dim idx As Integer
' Dim frm As FrmProperty
' 
' idx = m_frm_prop.Count
' frm = New FrmProperty
' m_frm_prop.Add(frm, idx)
' m_frm_prop[idx].Show
  l_key = m_selected_key
  Print "Parent " & modJSONParse.getParent(m_selected_key) & "    Key " & m_selected_key & " ==> \"" & cvJson.Item.Text & "\" : " & js.GetValueFromPath(m_selected_key)
  
  js.FindByKey(m_selected_key)
End

Private Function SelectedKey_Read() As String

  Return m_selected_key

End


